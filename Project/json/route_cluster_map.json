{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Interactive map of Canberra transit routes colored by service type cluster",
  "title": {
    "text": "Canberra Transit Network by Service Type",
    "subtitle": "Routes colored by K-means cluster classification (select route to highlight)",
    "anchor": "start"
  },
  "width": 700,
  "height": 700,
  "projection": {
    "type": "mercator"
  },
  "params": [
    {
      "name": "cluster_filter",
      "value": "All",
      "bind": {
        "input": "select",
        "options": [
          "All",
          "High-Frequency Core Corridors",
          "Frequent All-Week Services",
          "Standard Suburban Network",
          "Weekend Service Gap",
          "Weekday Peak-Only Express"
        ],
        "name": "Highlight Service Type: "
      }
    },
    {
      "name": "selected_route",
      "value": "All",
      "bind": {
        "input": "select",
        "options": [
          "All",
          "R1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
          "10",
          "18",
          "19",
          "20",
          "21",
          "22",
          "23",
          "24",
          "25",
          "26",
          "27",
          "28",
          "30",
          "31",
          "32",
          "40",
          "41",
          "42",
          "43",
          "44",
          "45",
          "46",
          "47",
          "50",
          "51",
          "53",
          "54",
          "55",
          "56",
          "57",
          "58",
          "59",
          "60",
          "61",
          "62",
          "63",
          "64",
          "65",
          "66",
          "70",
          "71",
          "72",
          "73",
          "74",
          "75",
          "76",
          "77",
          "78",
          "79",
          "80",
          "81",
          "903"
        ],
        "name": "Highlight Route: "
      }
    },
    {
      "name": "hover_route",
      "value": null
    }
  ],
  "layer": [
    {
      "name": "SA1 Boundaries",
      "data": {
        "url": "data/chart2a_sa1_boundaries.geojson",
        "format": {
          "type": "json",
          "property": "features"
        }
      },
      "transform": [
        {
          "lookup": "properties.SA1_Code",
          "from": {
            "data": {
              "url": "data/sa1_exclude.csv",
              "format": {
                "type": "csv",
                "parse": {
                  "sa1_code": "string"
                }
              }
            },
            "key": "sa1_code",
            "fields": [
              "sa1_code"
            ]
          },
          "as": [
            "excluded_sa1"
          ]
        },
        {
          "filter": "datum.excluded_sa1 == null"
        }
      ],
      "mark": {
        "type": "geoshape",
        "stroke": "#666666",
        "strokeWidth": 0.3,
        "fill": null,
        "fillOpacity": 0
      }
    },
    {
      "name": "All Routes",
      "data": {
        "url": "data/route_shapes_with_clusters.geojson",
        "format": {
          "type": "json",
          "property": "features"
        }
      },
      "transform": [
        {
          "filter": "isValid(datum.properties.cluster_name)"
        },
        {
          "calculate": "replace(toString(datum.properties.route_short_name), /\\.0$/, '')",
          "as": "route_str"
        }
      ],
      "params": [
        {
          "name": "route_hover_map",
          "select": {
            "type": "point",
            "fields": [
              "route_str"
            ],
            "on": "mouseover",
            "clear": "mouseout"
          }
        }
      ],
      "mark": {
        "type": "geoshape",
        "filled": false
      },
      "encoding": {
        "stroke": {
          "field": "properties.cluster_name",
          "type": "nominal",
          "title": "Service Type",
          "scale": {
            "domain": [
              "High-Frequency Core Corridors",
              "Frequent All-Week Services",
              "Standard Suburban Network",
              "Weekend Service Gap",
              "Weekday Peak-Only Express"
            ],
            "range": [
              "#029E73",
              "#0173B2",
              "#949494",
              "#ECA006",
              "#CC3311"
            ]
          },
          "legend": {
            "orient": "bottom-right",
            "direction": "vertical",
            "titleLimit": 200,
            "labelLimit": 220
          }
        },
        "strokeWidth": {
          "condition": [
            {
              "test": "hover_route != null && datum.route_str == hover_route",
              "value": 5
            },
            {
              "test": "selected_route != 'All' && datum.route_str == selected_route",
              "value": 5
            },
            {
              "param": "route_hover_map",
              "value": 3
            }
          ],
          "value": 2
        },
        "opacity": {
          "condition": [
            {
              "test": "cluster_filter != 'All' && datum.properties.cluster_name == cluster_filter",
              "value": 1
            },
            {
              "test": "cluster_filter != 'All'",
              "value": 0.1
            },
            {
              "test": "selected_route != 'All' && datum.route_str == selected_route",
              "value": 1
            },
            {
              "test": "selected_route != 'All'",
              "value": 0.2
            },
            {
              "test": "hover_route != null && datum.route_str == hover_route",
              "value": 1
            },
            {
              "test": "hover_route != null",
              "value": 0.3
            }
          ],
          "value": 0.9
        },
        "tooltip": [
          {
            "field": "properties.route_short_name",
            "type": "nominal",
            "title": "Route"
          },
          {
            "field": "properties.route_long_name",
            "type": "nominal",
            "title": "Route Name"
          },
          {
            "field": "properties.cluster_name",
            "type": "nominal",
            "title": "Service Type"
          }
        ]
      }
    }
  ],
  "config": {
    "view": {
      "stroke": "transparent"
    }
  }
}
