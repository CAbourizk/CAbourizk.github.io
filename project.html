<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="Chart_journal_look.css">
    <title>Canberra Public Transport Analysis - Clancy Abourizk</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.25.0"></script>
</head>

<body>
    <h1 class="big">
        Mind the gap: An assessment of Canberra's public transport network
    </h1>
    <p class="byline">
        <a href="index.html">Home</a> | <a href="https://cabourizk.github.io/portfolio">Portfolio</a> | <a href="https://www.linkedin.com/in/clancy-abourizk-0056b114b">LinkedIn</a> | <a href="https://github.com/CAbourizk/CAbourizk.github.io">GitHub</a>
    </p>

    <section>
        <div class="section-header">
           
            <p>
                Canberra has invested heavily in public transport, yet ridership remains low. Data suggests route coverage and reliability are reasonable, but weekend frequency remains a major gap in service coverage. This analysis examines Canbera's public transport service quality (coverage, frequency, reliability) falls short of likely demand in Canberra, and aims to identify which areas stand to benefit most from improvements.
            </p>
        </div>
    </section>

           <section>
        <div class="section-header">
            <h2>Coverage</h2>
            <p>
                For public transport to be competitive with private transport, users shouldn't have to walk far to find a stop. Transport planners use a convention of 600m walking distance as the upper bound of acceptable distance to walk to a stop. In Canberra, 94% of residents live within 600m from a public transport stop, with a median distance of 289m (well within the reccomended walking distance).
            </p>
        </div>
        <div class="chart-container">
            <div class="chart-item">
               
                <figure id="chart2a"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>
                        This choropleth map shows ACT Statistical Area Level 1 (SA1)<span class="footnote-pop" tabindex="0" role="button" aria-label="About SA1s" data-note="SA1s (Statistical Area Level 1) are the smallest Australian Bureau of Statistics geographic units, generally 200-800 residents, used for publishing census data.">[1]</span> colour-coded by population density (light pink to dark red), with transport stops: bus stops (blue circles) and light rail stops (gold squares). Use the selector above to switch between districts. Hover over SA1s to show the same SA1 in the chart to the right. Hovering over SA1s will also show a tool tip with  suburb name (SA2), district (SA3), population, and density data. Hover over stops to see stop names and details. The popout map on the right shows where that district is located within Canberra.
                        <br><strong>Data:</strong> ABS ASGS 2021 SA1 boundaries + Census G01 (<a href="https://www.abs.gov.au/statistics/standards/australian-statistical-geography-standard-asgs-edition-3/jul2021-jun2026/access-and-downloads/digital-boundary-files" target="_blank">ABS downloads</a>), Transport Canberra GTFS static feed 
                    </p>
                </details>
            </div>
            <div class="chart-item">
               
                <figure id="chart2b"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>
                        This scatter plot shows the relationship between SA1 population density and distance to the nearest bus stop for each SA1 in Canberra. This chart only shows SA1s with population density above 1,000 persons per km^2. This filtering was done to exclude a number of SA1s with very small populations. Use the selector to change from straight-line distance from SA1 centroid to closest stop to walking distance <span class="footnote-pop" tabindex="0" role="button" aria-label="Walking distance convention">[2]<span class="footnote-content">Source: <a href="https://www.trb.org/publications/tcrp/tcrp_webdoc_6-e.pdf" target="_blank">Transit Capcity and Quality Service Manual</a>.</span></span>. This walking distance scaling was applied in lieu of actual walking distance data
                        <br><strong>Data:</strong> ABS ASGS 2021 SA1 boundaries + Census G01, Transport Canberra GTFS static feed | <strong>Processing:</strong> <a href="https://colab.research.google.com/drive/1lNrpeBej0r0ZKsmww85uuUSg8E_KKJy-?usp=sharing" target="_blank">process_sa1_distance.py</a>, <a href="https://colab.research.google.com/drive/1iPriNRH4IIEnC-HLMWErAbzyVQI944Ju?usp=sharing" target="_blank">build_transit_stops.py</a>
                    </p>
                </details>
            </div>
        </div>
    </section>

   
    <section>
        <div class="section-header">
            <h2>Frequency</h2>
        </div>
        <p>For public transport to offer a viable alternative to private transport, people shouldn't have to wait too long inbetween services. Cities with the high public transport use often aim for times inbetween services (i.e. headways) of less than 5 minutes, so people don't need to plan their lives around bus timetables. Only two of Canberra's bus services reach this benchmark during peak commuting hours. While the light rail and other 'rapid' services have scheduled headways of less than 10 minutes, many of the suburban feeder routes have headways of more than 15 minutes. In a relatively compact city, 15 minutes headways dramatically reduces the competitivness of public transport with private transport. <br> The usability of the system really falls apart on weekends, when headways for most rapid routes stretch out to 15 minutes, and most suburban feeder routes have headways of more than 30 minutes. </p>
        <div class="chart-container">
            <div class="chart-item">
               
                <figure id="chart3a"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>
                        Interactive map showing all bus and light rail routes across Canberra, color-coded by service frequency (mean headway). Use the service period selector to view frequency for weekday peak, weekday off-peak, Saturday, or Sunday. Use the route selector to highlight individual routes. Hover over route path to highlight route in chart to the right.
                        <br><strong>Data:</strong> Transport Canberra GTFS static feed (<a href="https://www.transport.act.gov.au/contact-us/information-for-developers" target="_blank">API registration required</a>) | <strong>Processing:</strong> <a href="https://colab.research.google.com/drive/1YeuY_R8J5_Llgw6tuWQ0nbB8JX4IchrO?usp=sharing" target="_blank">download_gtfs_static.py</a>, <a href="https://colab.research.google.com/drive/1dQSU6yamkoIYsiEw-_RQnslHdpBlv1-I?usp=sharing" target="_blank">create_route_shapes_geojson.py</a>
                    </p>
                </details>
            </div>
            <div class="chart-item">
               
                <figure id="chart3b"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>
                        Mean headways for Canberra bus and light rail routes, with filtering by service type (peak/off-peak/weekend). 
                        <br><strong>Data:</strong> Transport Canberra GTFS static feed | <strong>Processing:</strong> <a href="https://colab.research.google.com/drive/1Hh1sje34c3TxngcytfeJXvifdMeUuYfc?usp=sharing" target="_blank">extract_headways_from_gtfs.py</a>
                    </p>
                </details>
            </div>
        </div>
    </section>

    <section>
        <div class="section-header">
            <h2>Reliability</h2>
        </div>
        <p>Reliability can be just as important as frequency, particularly for lower-frequency routes. Missing a suburban feeder route because it ran 5 minutes earlier than scheduled could make you 20 minutes late to work. In this way poor frequency compounds large headways to make public transport less competitive with private transport. The light rail, is by far and away the most reliable route in Canberra's network with 95% of arrivals happening within +/- 1 minute of schedule. Canberra's other rapid routes dont fair as well, with 84% of arrivals being more than 3 minutes ahead or behind schedule.</p>
        <div class="chart-container">
            <div class="chart-item">

                <figure id="chart4a"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>
                        Faceted histograms showing the distribution of arrival time deviations (scheduled vs actual) for Canberra's light rail and Rapid bus routes. Each panel represents one route, with delays binned into 1-minute intervals. The dashed vertical line at 0 represents perfect on-time performance. Data collected from ACT GTFS-Realtime API over a two-day period (23-24 December 2025). 
                        <br><strong>Data:</strong> Transport Canberra GTFS-Realtime API, polled every 60 seconds over a two-day period (<a href="https://www.transport.act.gov.au/contact-us/information-for-developers" target="_blank">API registration required</a>) | <strong>Processing:</strong> <a href="https://colab.research.google.com/drive/1pLAxwW3Z_EXnRBx5M8velSP3d2jmdxBl?usp=sharing" target="_blank">get_reliability_data.py</a>
                    </p>
                </details>
            </div>
            <div class="chart-item">
                
                <figure id="chart4b"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>
                        Stacked bar chart showing the percentage breakdown of arrival reliability for each route.
                        <br><strong>Data:</strong> Transport Canberra GTFS-Realtime API, polled every 60 seconds over a two-day period | <strong>Processing:</strong> <a href="https://colab.research.google.com/drive/1JXrgWu70VqfUrHcPN5CQAGrpZ0TZre4S?usp=sharing" target="_blank">create_ontime_percentage_data.py</a>
                    </p>
                </details>
            </div>
        </div>
    </section>


       <section>
        <div class="section-header">
            <h2>Looking for areas of latent demand</h2>
        </div>
        <p>Coverage, frequency, and reliability aren't the only determinants of public transport use. For example, a university student is often more likely to use public transport than a high-income retieree. Looking at these demographic variables we can try and find which areas of Canberra use more or less public transport than predicted by their demographic variables. If the ACT government wants to raise public transport use, it should focus on areas that have strong demographic predictors of public transport use, but poor service quality. 
            <br> Using machine learning techniques we can use census data to find SA1s with above and below expected public transport use. Comparing this to a service quality score, reveals 206 "undersupplied" SA1s covering 90,425 residents, with a high propensity to use public transport but low quality.</p>
                
        <div class="chart-container">
            <div class="chart-item">
                <figure id="chart5a"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>This chart estimates demographic propensity for PT usage using census variables.</p>
                    <p>
                        <strong>Method:</strong> A single Gradient Boosting model trained on demographics variables (occupation, age, labour force participation, education, and income). The target is public transport commute rate from the census, using the same train-test split across SA1s.
                    </p>
                    <p>
                        <strong>Findings:</strong> Demographics alone explain a modest share of the variation in public transport commuting (R²=0.185). The scatter shows wide dispersion around the diagonal, indicating that demographic characteristics are only a partial predictor of PT usage across SA1s.
                    </p>
                    <p>
                        <strong>Data:</strong> ABS Census 2021 (7 tables: G01, G02, G13, G16, G17B, G43, G51) + SA1 boundaries | <strong>Processing:</strong> <a href="https://github.com/CAbourizk/CAbourizk.github.io/blob/main/scripts/ml_pt_commuting_rate.py" target="_blank">ml_pt_commuting_rate.py</a>
                    </p>
                </details>
            </div>
            <div class="chart-item">
                <figure id="chart5b"></figure>
                <details class="intro-panel">
                    <summary>Technical notes</summary>
                    <p>This chart takes the public transport use propensity score from the chart on the left and compares it to public transport quality for each SA1.</p>
        
                    <p>
                        <strong>Method:</strong> Using a K-means clustering (k=4) SA1s are clustered based on two composite scores: <strong>Demand Score</strong> – based on demographic indicators of public transport propensity , and (2) <strong>Supply Score</strong> – service quality indicators (proximity to closest stop, service frequency, departures per capita, service consistency ratios). Areas are clustered into four policy-relevant groups.
                    </p>
                    <p>
                        <strong>Findings:</strong> The clustering reveals 206 "Undersupplied Urban" SA1 areas (red points) serving 90,425 residents who high demographic public transport propensity scores but receive below-average service quality. The "Urban Core - Well Served" cluster (green, 131 SA1s) demonstrates what's possible: similar demographics but 1.7× the service level results in higher public transport usage. 
                    </p>
                    <p>
                        <strong>Data:</strong> ABS Census 2021 + Transport Canberra GTFS + SA1 boundaries | <strong>Processing:</strong> <a href="https://github.com/CAbourizk/CAbourizk.github.io/blob/main/scripts/ml_pt_clustering_mismatch.py" target="_blank">ml_pt_clustering_mismatch.py</a>
                    </p>
                </details>
            </div>
        </div>


    </section>

    <section>
        <div class="section-header">
            <h2>Conclusions</h2>
            <p>
             This analysis reveals that Canberra's public transport network is built primarily around weekday peak commuting, and isn't fit to replace private transport for most people. Coverage is the strongest point in the network, with the vast majority of people living within a reasonable walk from a stop. Feeder route frequency (particuarlly on weekends) is the clearest weak point in the network and likely the strongest barrier to broader use. 

	<br>The ACT government's public transport strategy in recent years has focused on extending the light rail network to Woden. Scheduled to open in 2033, this will replace the Civic to Woden segment of the rapid 4 bus. While this will likely improve realiabilty of this service, this corridor is alread served by the highest frequency of bus services. If aiming to raise ridership across the network, more investment should be put into improving service frequecy, particuarlly for feeder routes. The results of this analysis suggest that around a quarter of Canberra's population is underserved by service quality. These areas should be prioritised for service improvements.
 </p>
        </div>
    </section>

    <div class="intro-panels">
        <div class="intro-panels-grid">
            <details class="intro-panel">
                
                <!-- Data -->
                <summary>Data</summary>
                <p>
                    	This analysis draws on data from a range of publicly available sources (see below). Some data (like that from the ABS) was relatively easy to work with (coming in CSV format), and mainly required hunting down the right files. The remainder of the data came from the Transport ACT API. Signing up was easy enough, but sparse documentation and a small user community meant a fair bit of time was spent getting it to work.
                </p>
                <p>
                The reliability measure is the only data that is not directly replicable. This data was not published, but I was able to use the API and a python script to collect the service lateness data over a two day period (23-24 December 2025). I have included a link to a colab workbook with the code that was used to capture this information [here]. I acknowledge that the days leading up to Christmas may not be a representative sample, so I encourage others to collect more data over a longer period before drawing solid policy conclusions.
                <p>
                 	While others can use this script to collect new data, I should note that little time was spent optimising for the file size vs granularity tradeoff. The file size grew relatively large relatively quickly (47MB for 2 days). If this work was to be extended more thought should be paid to this (perhaps collecting data less frequently or compressing the data into summary statistics). 
                    <br>To test the hypothesis that improved service quality can induce greater public transport use more directly, it would be good to have ridership data for each service. This could have been used to predict usage for each route based on proximity, frequency, and reliability measures. This data was previously published by the ACT Government but stopped in 2017. 
                </p>

                <p><strong>Data Sources:</strong></p>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; margin-bottom: 25px;">
                    <thead>
                        <tr style="background-color: #e0e0e0;">
                            <th style="padding: 10px; text-align: left; border: 1px solid #ccc;">Source</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ccc;">Description</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ccc;">Access Method</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ccc;">Update Frequency</th>
                        </tr>
                    </thead>
                    <tbody>
                                                <tr>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                <a href="https://www.abs.gov.au/websitedbs/D3310114.nsf/Home/2021%20Census%20Tools" target="_blank">
                                ABS Census 2021</a>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                Demographics, JTW, income, education (7 tables: G01, G02, G13, G16, G17B, G43, G51)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">TableBuilder download (CSV)</td>
                            <td style="padding: 8px; border: 1px solid #ccc;">Every 5 years</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                <a href="https://www.abs.gov.au/statistics/standards/australian-statistical-geography-standard-asgs-edition-3/jul2021-jun2026/access-and-downloads/digital-boundary-files" target="_blank">
                                ABS ASGS 2021</a>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                SA1 statistical boundaries (shapefiles, GDA2020)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">Manual download (ZIP)</td>
                            <td style="padding: 8px; border: 1px solid #ccc;">Annual</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                <a href="https://www.transport.act.gov.au/contact-us/information-for-developers" target="_blank">
                                ACT GTFS Static</a>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                Bus routes, stops, timetables (GTFS format)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                Authenticated API (<code>download_gtfs_static.py</code>)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">Weekly (automated)</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                <a href="https://www.transport.act.gov.au/contact-us/information-for-developers" target="_blank">
                                ACT GTFS-Realtime</a>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                Live bus arrival predictions (Protobuf format)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                Polling API (<code>get_reliability_data.py</code>, 60s intervals)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">Continuous (real-time)</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                ACT Open Data Portal
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">
                                Light rail stops and route geometry (GeoJSON)
                            </td>
                            <td style="padding: 8px; border: 1px solid #ccc;">Manual download</td>
                            <td style="padding: 8px; border: 1px solid #ccc;">As updated</td>
                        </tr>
                    </tbody>
                </table>
            </details>
            <details class="intro-panel">
                
                <!-- Tools -->
                <summary>Tools</summary>
                <p>
                    <strong>Coverage charts:</strong> One of the major data cleaning operations was trimming down the list of SA1s. The ACT is relatively small, but Canberra itself is even smaller. This made maps hard to read because the Canberra segment was relatively small (and Vega-Lite does not allow zoom and panning). As the ABS dataset included SA1s for all of the ACT, I manually filtered out SA1s that were outside of Canberra's urban boundaries. The populations affected are very small (11 SA1s with <50 total residents) and ACT transport does not serve these areas. To extend this project, you could explore creating the maps in a different language that allows zooming and panning. This could be a more intuitive experience for readers than drop down menus switching between areas.
                </p>
                <p>
                    The distance to nearest stop measure was generated by a python script that took the centre point of each SA1, and measured the straight-line distance to the nearest GTFS stop. Acknowledging that people can't walk as the crow flies, I then scaled the distance up by x1.35 as advised in [x]. To extend this work further you could improve the accuracy of this measure by using [map layers that included streets and walking paths].
                </p>
                <p>
                    <strong>Frequency charts:</strong> I extracted route shapes and stop times from the GTFS static feed, then computed mean headways by route for weekday peak/off-peak and Saturday/Sunday windows. Light rail headways were added from published timetable data because they are not in the GTFS feed.
                </p>
                <p>
                    <strong>Reliability charts:</strong> This data was collected from the GTFS feed with a python script [insert colab link]. One of the issues with collecting this data was the need to run a script continuously over a long period. This meant the need to keep my laptop running for 2 days without sleeping. This took a little while to get up and running because I had some issues with my script not saving the data properly. As the collection window was overnight (London time), trouble shooting was a multi-day affair. To extend this work, it would be good to run the script on a server so it could run for a longer time period. As noted above, it would be good to run the collection for a longer and more representative time period.
                </p>
                <p>
                    <strong>Machine learning charts:</strong> I merged ABS Census SA1 demographics with service-quality features (distance to stops, headways/departures, and reliability) and trained gradient boosting models to compare demographics-only, service-only, and combined predictors of PT commuting. I also used k-means clustering to group routes and SA1s into policy-relevant service types.
                </p>

                
                <p><strong>Coding Stack:</strong></p>
                <ul style="font-size: 0.95em; line-height: 1.6;">
                    <li><strong>Python 3.10</strong> for all data processing (pandas, geopandas, scikit-learn)</li>
                    <li><strong>Vega-Lite 5</strong> for interactive visualizations embedded via vegaEmbed CDN</li>
                    <li><strong>GitHub Pages</strong> for hosting (static site, no server-side processing)</li>
                </ul>

                <p><strong>Reproducibility:</strong> All Python scripts are available in the
                    <a href="https://github.com/CAbourizk/CAbourizk.github.io/tree/main/scripts" target="_blank">
                    GitHub repository</a>. See the README for setup instructions and script execution order.
                </p>
            </details>
        </div>
    </div>

    <h3>Generative AI use disclaimer</h3>
    <p>Generative AI (Claude, Chat GPT, Gemini, Copilot) was used in producing this website. These tools were used to trouble shoot code, and help produce the more complicated python scripts.</p>
   

    <script>
        // ============================================
        // SECTION 1: INTRO PANEL INTERACTIVITY
        // ============================================
        // Handle expand/collapse behavior for intro panels
        document.querySelectorAll('.intro-panel').forEach(panel => {
            const summary = panel.querySelector('summary');
            if (!summary) return;
            summary.addEventListener('click', event => {
                event.preventDefault();
                if (panel.hasAttribute('open')) {
                    panel.removeAttribute('open');
                } else {
                    panel.setAttribute('open', '');
                }
            });
        });

        // ============================================
        // SECTION 2: CHART CONFIGURATION
        // ============================================
        // Define all charts in one array - each chart has an id (where to put it) and spec (the chart definition)
        // Note: Chart 2a is Not in this array because it's rendered separately with district selector
        const charts = [
            { id: '#chart2b', spec: 'Project/json/chart2b.json' },
            { id: '#chart3a', spec: 'Project/json/chart3a.json' },
            { id: '#chart3b', spec: 'Project/json/chart3b.json' },
            { id: '#chart4a', spec: 'Project/json/chart4a.json', renderer: 'svg' },
            { id: '#chart4b', spec: 'Project/json/chart4b.json' },
            { id: '#chart5a', spec: 'Project/json/chart5a.json' },
            { id: '#chart5b', spec: 'Project/json/chart5b.json' }
        ];

        // ============================================
        // SECTION 3: CHART EMBEDDING
        // ============================================
        // Store chart views for cross-chart communication
        const chartViews = {};

        // Chart 2a special handling (district selector requires separate rendering)
        let chart2aView = null;
        let chart2aHoverHandler = null;
        let chart2bHoverHandler = null;

        // Setup bidirectional hover linking between Chart 2a and Chart 2b
        const setupChart2Link = () => {
            const chart2bView = chartViews['#chart2b'];
            if (!chart2aView || !chart2bView) return;

            if (chart2aHoverHandler) {
                chart2aView.removeSignalListener('sa1_hover_sel_map', chart2aHoverHandler);
            }
            if (chart2bHoverHandler) {
                chart2bView.removeSignalListener('sa1_hover_sel_scatter', chart2bHoverHandler);
            }

            chart2aHoverHandler = (name, value) => {
                const code = value?.sa1_code ? String(value.sa1_code) : null;
                chart2bView.signal('hover_sa1_ext', code).run();
            };
            chart2bHoverHandler = (name, value) => {
                const code = value?.sa1_code ? String(value.sa1_code) : null;
                chart2aView.signal('hover_sa1_ext', code).run();
            };

            chart2aView.addSignalListener('sa1_hover_sel_map', chart2aHoverHandler);
            chart2bView.addSignalListener('sa1_hover_sel_scatter', chart2bHoverHandler);
        };

        // Embed all main charts (2b, 3a, 3b, 4a, 4b, 5a, 5b)
        // Note: Chart 2a is handled separately below due to district selector
        const embedPromises = charts.map(chart => {
            const options = {
                actions: false,
                renderer: chart.renderer || 'canvas',
                config: {
                    autosize: {
                        type: 'fit',
                        contains: 'padding'
                    }
                }
            };

            return vegaEmbed(chart.id, chart.spec, options).then(result => {
                // Make chart responsive by fitting to container width
                const view = result.view;
                chartViews[chart.id] = view;
                const container = document.querySelector(chart.id);
                if (container) {
                    const resizeChart = () => {
                        const width = container.clientWidth;
                        view.width(width - 40).run();
                    };
                    window.addEventListener('resize', resizeChart);
                    resizeChart();
                }
                return result;
            });
        });

        // ============================================
        // SECTION 4: CHART LINKING & INTERACTIVITY
        // ============================================
        // Setup cross-chart communication after all charts are embedded
        Promise.all(embedPromises).then(() => {
            // Chart 3a ↔ Chart 3b: Service type sync and hover linking
            const chart3aView = chartViews['#chart3a'];
            const chart3bView = chartViews['#chart3b'];
            if (!chart3aView || !chart3bView) return;
            let syncServiceType = false;

            chart3aView.addSignalListener('service_type', (name, value) => {
                if (syncServiceType) return;
                syncServiceType = true;
                if (chart3bView.signal('service_type') !== value) {
                    chart3bView.signal('service_type', value).run();
                }
                syncServiceType = false;
            });
            chart3bView.addSignalListener('service_type', (name, value) => {
                if (syncServiceType) return;
                syncServiceType = true;
                if (chart3aView.signal('service_type') !== value) {
                    chart3aView.signal('service_type', value).run();
                }
                syncServiceType = false;
            });

            // Route hover handlers for Chart 3a ↔ Chart 3b
            chart3bView.addSignalListener('route_hover_sel', (name, value) => {
                let route = null;
                if (value && typeof value === 'object' && value.route_str !== undefined && value.route_str !== null) {
                    route = String(value.route_str);
                }
                chart3aView.signal('hover_route', route).run();
            });
            chart3aView.addSignalListener('route_hover_map', (name, value) => {
                let route = null;
                if (value && typeof value === 'object' && value.route_str !== undefined && value.route_str !== null) {
                    route = String(value.route_str);
                }
                chart3aView.signal('hover_route', route).run();
                chart3bView.signal('hover_route_ext', route).run();
            });

            // Setup Chart 2a ↔ Chart 2b linking
            setupChart2Link();
        });

        // ============================================
        // SECTION 5: CHART 2A DISTRICT SELECTOR
        // ============================================
        // Chart 2a requires special handling because it has a district selector that dynamically loads different chart specifications
        const chart2aSpecs = {
            belconnen: 'Project/json/chart2a_belconnen.json',
            tuggeranong: 'Project/json/chart2a_tuggeranong.json',
            gungahlin: 'Project/json/chart2a_gungahlin.json',
            north: 'Project/json/chart2a_north_canberra.json',
            woden: 'Project/json/chart2a_woden_valley.json',
            south: 'Project/json/chart2a_south_canberra.json',
            weston: 'Project/json/chart2a_weston_creek.json',
            molonglo: 'Project/json/chart2a_molonglo.json'
        };

        function renderChart2a(specPath, selectedKey) {
            const container = document.querySelector('#chart2a');
            container.innerHTML = '';
            const selectorWrap = document.createElement('div');
            selectorWrap.style.cssText = 'margin: 0 0 8px 0; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;';
            const label = document.createElement('label');
            label.textContent = 'Select district:';
            label.htmlFor = 'chart2a-selector-inline';
            const select = document.createElement('select');
            select.id = 'chart2a-selector-inline';
            for (const [key, path] of Object.entries(chart2aSpecs)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = {
                    belconnen: 'Belconnen',
                    tuggeranong: 'Tuggeranong',
                    gungahlin: 'Gungahlin',
                    north: 'North Canberra',
                    woden: 'Woden Valley',
                    south: 'South Canberra',
                    weston: 'Weston Creek',
                    molonglo: 'Molonglo'
                }[key] || key;
                if (key === selectedKey) opt.selected = true;
                select.appendChild(opt);
            }
            selectorWrap.appendChild(label);
            selectorWrap.appendChild(select);

            const chartDiv = document.createElement('div');
            chartDiv.id = 'chart2a-view';

            container.appendChild(selectorWrap);
            container.appendChild(chartDiv);

            // Using SVG renderer for Chart 2a because canvas has hover detection issues with complex geoshapes (hover highlights wrong SA1 regions)
            vegaEmbed(chartDiv, specPath, { actions: true, renderer: 'svg' }).then(result => {
                if (chart2aView && chart2aHoverHandler) {
                    chart2aView.removeSignalListener('sa1_hover_sel_map', chart2aHoverHandler);
                }
                chart2aView = result.view;
                setupChart2Link();
            });

            select.addEventListener('change', (event) => {
                const key = event.target.value;
                renderChart2a(chart2aSpecs[key], key);
            });
        }

        // Initial render with default selection
        renderChart2a(chart2aSpecs['belconnen'], 'belconnen');
    </script>


</body>
</html>
